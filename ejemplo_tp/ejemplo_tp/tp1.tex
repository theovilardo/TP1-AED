\documentclass[10pt,a4paper]{article}

\input{AEDmacros}
\usepackage{caratula} % Version modificada para usar las macros de algo1 de ~> https://github.com/bcardiff/dc-tex


\titulo{Descripci\'on del tp}
\subtitulo{Subtítulo del tp}

\fecha{\today}

\materia{Materia de la carrera}
\grupo{Grupo 42}

\integrante{Nabot, Teo}{996/22}{teonabot@gmail.com}
\integrante{Santillan, Lautaro}{370/22}{lautisantil@gmail.com}
\integrante{Vilardo, Theo}{743/22}{theovilardo@gmail.com}
\integrante{Recchini, Nicolás Gabriel}{37/23}{nicolas.recchini@gmail.com}
% Pongan cuantos integrantes quieran

% Declaramos donde van a estar las figuras
% No es obligatorio, pero suele ser comodo
\graphicspath{{../static/}}

\begin{document}

\maketitle

\section{Ejemplo de sección}

\subsection{Macros de la cátedra para especificar}

%ejemplo proc
% \begin{proc}{nombre}{\In paramIn : \nat, \Inout paramInout : \TLista{\ent}}{tipoRes}
% 	%    \modifica{parametro1, parametro2,..}
% 	\requiere{expresionBooleana1}
% 	\asegura{expresionBooleana2}
% 	\aux{auxiliar1}{parametros}{tipoRes}{expresion}
% 	\pred{pred1}{parametros}{expresion} 
% \end{proc}

\begin{proc}{redistribucionDeLosFrutos}{\In recursos : \TLista{\float}, \In cooperan : \TLista{\bool}}{\TLista{\float}}
	\requiere{|recursos| = |cooperan|}
	\asegura{res = fondoMonetario(recursos, cooperan) / |recursos|}
	\aux{fondoMonetario}{\In recursos : \TLista{\float}, \In cooperan : \TLista{\bool}}{\float}{\sum_{i=0}^{n} {\IfThenElse{cooperan[i]}{recursos[i]}{0}}}
\end{proc}

%aqui iria un espacio
\vspace{1cm}

\begin{minipage}[t]{19cm}
\aux{calcularFondoComun}{trayectorias : \TLista{\TLista{\mathds{R}}}, cooperan : \TLista{\bool}, apuestas : \TLista{\TLista{\mathds{R}}}, pagos : \TLista{\TLista{\mathds{R}}}, eventos : \TLista{\TLista{\mathds{N}}}}{\float}{%
	%\begin{equation}
	\sum\limits_{i=0}^{| trayectorias | - 1} \IfThenElse{cooperan[i] = true}{trayectorias[i][r - 1] * apuestas[i][eventos[i][r - 1]] * pagos[i][eventos[i][r - 1]]}{\text{0}}
	\label{eq:1} 
	%\end{equation}
}
\end{minipage}

\vspace{1cm}

\begin{minipage}[t]{19cm}
\aux{calcularRecurso}{recurso: \float, coop: \bool, apuesta: \float, pago: \float, fondoComun: \float, cantidadDeJugadores: \nat}{\float}{%
	res = dividirFondos(apuesta * pago * recurso, coop, fondoComun, cantidadDeJugadores)
}
\end{minipage}

%aqui va un espacio
\vspace{1cm}

\begin{minipage}[t]{19cm}
\aux{dividirFondos}{nuevoRecurso: \float, coop: \bool, fondoComun: \float, cantidadDeJugadores: \nat}{\float}{%
	res = \IfThenElse{coop = true}{$\[\frac{\text{fondoComun}}{\text{cantidadDeJugadores}}\]$}{\text{$\frac{\text{fondoComun}}{\text{cantidadDeJugadores}} + \text{nuevoRecurso}$}}
}
\end{minipage}

\begin{proc}{trayectoriaExtrañaEscalera}{\In trayectorias : \TLista{\float}}{\bool}
	\requiere{|trayectorias| > 0}
	\asegura{%
		res = \existe{i}{\nat}{0 \leq i < |trayectoria| \yLuego trayectoria[i] > trayectoria[i+1] \wedge trayectoria[i] > trayectoria[i-1]} \land (\not\exists{j}:{\nat})(i = j \land 0 \leq j < |trayectoria| \yLuego trayectoria[j] > trayectoria[j+1] \wedge trayectoria[j] > trayectoria[j-1])
		}
\end{proc}

\begin{minipage}{19cm}
\begin{proc}{trayectoriaDeLosFrutosIndividualesALargoPlazo}{\Inout trayectorias : \TLista{\TLista{\mathds{R}}}, \In cooperan : \TLista{\bool}, \In apuestas : \TLista{\TLista{\mathds{R}}}, \In pagos : \TLista{\TLista{\mathds{R}}}, \In eventos : \TLista{\TLista{\mathds{N}}}}{}
	%    \modifica{parametro1, parametro2,..}
	\requiere{%
		{trayectoria = old{(trayectorias)}} \newline {\land trayectoriaInicialValida(old{(trayectorias)})} \newline {\land apuestasValidas(apuestas)} \newline {\land 				\text{mismoTamañoLista(old{(trayectorias)}, apuestas, pagos, eventos, cooperan)}} \newline {\land \text{mismoTamañoSubListas(apuestas, pagos)}} \newline {\land 			\text{eventosValidos(eventos, apuestas)}}
	}
	\asegura{%
		|trayectorias| = old{(trayectorias)} \land trayectoriasFinalesValidas(trayectorias, eventos)
	}
	\asegura{%
	\paraTodo[unalinea]{j}{\ent}{0 \leq j < \left| trayectorias |\right} \implica {trayectorias[j][0] = old{(trayectorias[j][0])}}
	} 
	\asegura{%
	\paraTodo[unalinea]{j, r}{\ent}{0 \leq j < |trayectorias|}{\implicaLuego
	(0 < r < |eventos[j]|)} \implica trayectorias[j][r] = 
	calcularRecurso(
		trayectorias[j][r - 1],
		cooperan[j],
		pagos[j][eventos[j][r - 1]],
		apuestas[j][r - 1],
		calcularFondoComun(trayectoria, cooperan, apuestas, pagos, eventos, r)),
		| trayectorias |
	}
\end{proc}
\end{minipage}

%Preds y Aux para los requiere:

%aqui va un espacio
\vspace{1cm}

\pred{apuestasValidas}{s: \TLista{\TLista{\float}}}{\paraTodo[unalinea]{i}{\ent}{0 \leq j < |s|} \implicaLuego {(sumaElementos(s[i]) = 1)}}

%aqui va un espacio
\vspace{1cm}

\aux{sumaElementos}{s: \TLista{\float}}{\ent}{%
	\sum\limits_{k=0}^{| s | - 1} s[k]
}

%aqui va un espacio
\vspace{1cm}

\pred{mismoTamañoListas}{s1, s2, s3: \TLista{\TLista{\float}}, s4: \TLista{\TLista{\nat}}, s5: \TLista{\bool}}{|s1| = |s2| \land |s2| = |s3| \land |s3| = |s4| \land |s4| = |s5|}

%aqui va un espacio
\vspace{1cm}

\pred{mismoTamañoSublistas}{s1, s2: \TLista{\TLista{\float}}}{\paraTodo[unalinea]{i}{\ent}{0 \leq i < |s1| \implicaLuego |s1[i]| = |s2[i]|}}

%aqui va un espacio
\vspace{1cm}

\pred{eventosValidos}{s: \TLista{\TLista{\nat}}, l: \TLista{\TLista{\float}}}{\paraTodo[unalinea]{i}{\ent}{0 \leq i < |s| -1 \implicaLuego |s[i]| = |s[i]| + 1} \land {\paraTodo[unalinea]{m}{\ent}{0 \leq m < |s| \implicaLuego {\paraTodo[unalinea]{n}{\ent}{0 \leq n < |s[m]| \implicaLuego 0 \leq s[m][n] < |[m]|}}}}}

%aqui va un espacio
\vspace{1cm}

\pred{trayectoriaInicialValida}{s: \TLista{\TLista{\float}}}{\paraTodo[unalinea]{i}{\ent}{0 \leq i |s| \implicaLuego |s[i]| = 1}}

%aqui va un espacio
\vspace{1cm}

\pred{trayectoriasFinalesValidas}{s1: \TLista{\TLista{}}, s2: \TLista{\TLista{\nat}}}{\paraTodo[unalinea]{i}{\ent}{0 \leq i < |s1| \implicaLuego |s1[i]| = |s2[i]| + 1}}

% \paraTodo{variable}{tipo}{expresion}
% \existe{variable}{tipo}{expresion}
% Pueden tener [unalinea] para que no se divida en varias lineas

\begin{proc}{individuoDecideSiCooperarONo}{\In individuo: \nat, \In recursos : \TLista{\float}, \Inout cooperan : \TLista{\bool}, \In apuestas : \TLista{\TLista{\float}}, \In pagos : \TLista{\TLista{\float}}, \In eventos : \TLista{\TLista{\nat}}}
	\asegura{cooperan[i] = {\IfThenElse}{calcularUltimoRecurso(individuo, recursos, indSimulaCooperar(), apuestas, pagos, eventos)>calcularUltimoRecurso(individuo, recursos, indSimulaCooperar(), apuestas, pagos, eventos)}{True}{False} }
\end{proc}

\aux{calcularUltimoRecurso}{\In i: \nat, \In rs : \TLista{\float}, \Inout coop : \TLista{\bool}, \In as : \TLista{\TLista{\float}}, \In ps : \TLista{\TLista{\float}}, \In es : \TLista{\TLista{\nat}}}{\float}{calcularRecursos(|es[i]|-1, rs, coop, as, ps, es)[i]}

\aux{calcularRecursos}{t, rs, coop, as, ps, es}{\float}{\paraTodo i:\ent, }


\aux{auxiliarSuelto}{parametros}{tipoRes}{expresion}
% \paraTodo{variable}{tipo}{expresion}
% \existe{variable}{tipo}{expresion}
% Pueden tener [unalinea] para que no se divida en varias lineas
\pred{predSuelto}{parametros}{\paraTodo[unalinea]{variable}{tipo}{algo \implicaLuego expresion}}
\pred{predSuelto}{parametros}{\existe[unalinea]{variable}{tipo}{algo \yLuego expresion}}

\subsection{Demostración de correctitud}

Para probar la correctitud parcial del ciclo, se propone el invariante:
\begin{equation}
	I = 0 \leq i < |evs| \wedge res = rec (ap_c pa_c)^{\# apariciones(subseq(0, i, evs), T)}(ap_s pa_s)^{\#apariciones(subseq(0, i, evs), F)}
\end{equation}	
donde se usaron (y usarán) las abreviaturas $rec = recurso$, $ap = apuesta$, $pa = pago$, $evs = eventos$.\\

Así, por el teorema del invariante, el ciclo $while(B) \, do \, S$ es parcialmente correcto respecto $(P_c, Q_c) $ sii:

\begin{enumerate} \setlength\itemsep{0cm}
	\item $P_c \implica I$
	\item $\{I \wedge B \} S \{I\}$
	\item $\{I \wedge \neg B \} \implica Q_c$
\end{enumerate}

Para probar 1. tenemos $P_c = i=0 \wedge res=rec \wedge ap_c + ap_s = 1 \wedge p_c > 0 \wedge p_s > 0 \wedge ap_c > 0 \wedge ap_s > 0 \wedge rec > 0$ y queremos ver que \\ $0 \leq i < |evs| \wedge res = rec (ap_c pa_c)^{\# apariciones(subseq(evs, 0, i), T)}(ap_s pa_s)^{\#apariciones(subseq(evs, 0, i), F)$

\begin{proof}
    $P_c \implica  i = 0 \implica 0 \leq i < |evs| \wedge subseq(evs, 0, i) \equiv subseq(evs, 0, 0) \equiv \lvacia \\
    \implica \#(subseq(evs, 0, i), T) = \#(subseq(evs, 0, i), F) \equiv 0  \\
    \implica (ap_c pa_c)^{\#(subseq(evs, 0, i), T)} = (ap_s pa_s)^{\#(subseq(evs, 0, i), F)} \equiv 1 \\
	\implica rec * (ap_c pa_c)^{\#(subseq(evs, 0, i), T)} * (ap_s pa_s)^{\#(subseq(evs, 0, i), F)} \equiv rec $\\
    Además, $P_c$ \implica $res = rec$. Luego, $res = rec * (ap_c pa_c)^{\#(subseq(evs, 0, i), T)} * (ap_s pa_s)^{\#(subseq(evs, 0, i), F)} \wedge 0 \leq i < |evs|$, que es el invariante.
\end{proof}

Luego, para probar 2., tenemos que ver que la tripla de Hoare $\{I \wedge B \} S \{I\}$ es válida, es decir, probar que $wp(S, I) \implica \{I \wedge B \}$.\\

\begin{proof}
    Tenemos que $S \equiv S1; S2$, con $S1 \equiv \IfThenElse{eventos[i]}{res:=res * ap_c * p_c}{res:=res*ap_s*p_s}$ y $S2 \equiv i:= i+1$\\
	$wp(S, I) \equiv wp(S1; S2, I) \equiv wp(S1, wp(S2, I))$.
	Caclulemos primero $wp(S2, I)$. \\ 
	$wp(S2, I) \equiv def(i+1) \yLuego I_{i+1}^i \equiv I_{i+1}^i \equiv\\
	0 \leq i+1 \geq |evs| \wedge res = rec *  (ap_c * pa_c)^{\#(subseq(evs, 0, i+1), true)} * (ap_s * pa_s)^{\#(subseq(evs, 0, i+1), false)}$\\
	$wp(S1, wp(S2, I)) \equiv wp(S1, I_{i+1}^i) \equiv def(evs[i]) \yLuego ((evs[i] \wedge wp(res:=res * ap_c * pa_c, I_{i+1}^i)) \vee (evs[i] = false \wedge wp(res:=res * ap_s * pa_s, I_{i+1}^i)) ) $\\
	$\equiv 0 \leq i < |evs| \yLuego ((evs[i] = true \wedge wp_1) \vee (evs[i] = false \wedge wp_2))$, donde \\
	$wp_1 \equiv wp(res:= res* ap_c * pa_c, I_{i+1}^i)$ y $wp_2 \equiv wp(res:= res*ap_s *pa_s, I_{i+1}^i)$. 
	Procedemos a calcular $wp_1, wp_2$\\
	$wp_1 \equiv def (res*ap_s*pa_s) \yLuego (I_{i+1}^i)_{res*ap_c*pa_c}^{res} \equiv (I_{i+1}^i)_{res*ap_c*pa_c}^{res} \equiv$
	$\equiv 0\leq i+1 \leq |evs| \wedge res * ap_c * pa_c = rec *(ap_ * pa_c)^{\#(subseq(evs, 0, i+1), true)} * (ap_s * pa_s)^{\#(subseq(evs, 0, i+1), false)}$\\
	$\equiv 0\leq i+1 \leq |evs| \wedge res = rec *(ap_c * pa_c)^{\#(subseq(evs, 0, i+1), true) - 1} * (ap_s * pa_s)^{\#(subseq(evs, 0, i+1), false)}$\\
	Véase que se pudo pasar dividiendo $ap_c * pa_c$ porque $ap_c * pa_c > 0 \implica ap_c * pa_c \not= 0$ \\
	Similarmente,
	$wp_2 \equiv def (res*ap_s*pa_s) \yLuego (I_{i+1}^i)_{res*ap_s*pa_s}^{res} \equiv (I_{i+1}^i)_{res*ap_s*pa_s}^{res} \equiv$
	$\equiv 0\leq i+1 \leq |evs| \wedge res * ap_s * pa_s = rec *(ap_c * pa_c)^{\#(subseq(evs, 0, i+1), true)} * (ap_s * pa_s)^{\#(subseq(evs, 0, i+1), false)}$\\
	$\equiv 0\leq i+1 \leq |evs| \wedge res = rec *(ap_c * pa_c)^{\#(subseq(evs, 0, i+1), true)} * (ap_s * pa_s)^{\#(subseq(evs, 0, i+1), false) - 1}$\\
	Reemplazando $wp_1, wp_2$ respectivamente, llegamos a \\
	$wp(S, I) \equiv 0 \leq i < |evs| \yLuego ((evs[i] = true \wedge 0\leq i+1 \leq |evs| \wedge res = rec *(ap_c * pa_c)^{n - 1} * (ap_s * pa_s)^m) \vee $\\
	$(evs[i] = false) \wedge 0\leq i+1 \leq |evs| \wedge res = rec *(ap_c * pa_c)^n} * (ap_s * pa_s)^{m - 1})$\\
	con $n = \#apariciones(subseq(evs, 0, i+1), true) \wedge m = \#apariciones(subseq(evs, 0, i+1), false)$\\
	Sacando $0 \leq i+1 \leq |evs|$ como factor común de la disyunción y observando que $0 \leq i < |evs| \implica 0 \leq i + 1 \leq |evs|$, resulta:
	\begin{equation}
		wp(S, I) \equiv 0 \leq i < |evs|  \yLuego ((evs[i] \wedge res = rec *(ap_c * pa_c)^{n - 1} * (ap_s * pa_s)^m) \vee 
		(\neg evs[i]) \wedge res = rec *(ap_c * pa_c)^n * (ap_s * pa_s)^{m - 1})
	\end{equation}

\end{proof}

\\Luego, para probar 3., tenemos

\begin{proof}
	$ \{\neg B \wedge  I\} \implica i \geq |evs| \wedge 0 \geq i \leq |evs|	\implica i = |evs| \\$
	Luego, $I \wedge i = |evs| \implica res = rec * (ap_c pa_c)^{\#(subseq(evs, 0, i), T)} * (ap_s pa_s)^{\#(subseq(evs, 0, i), F)} \\
	= rec * (ap_c pa_c)^{\#(subseq(evs, 0, |evs|), T)} * (ap_s pa_s)^{\#(subseq(evs, 0, |evs|), F)} = rec * (ap_c pa_c)^{\#(evs, T)} * (ap_s pa_s)^{\#(evs, F)} $ 
\end{proof}

\end{document}
